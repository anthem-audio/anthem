name: Build Anthem
on: [push]
jobs:
  build:
    runs-on: [windows-latest]
    steps:
      - name: Check out Anthem
        uses: actions/checkout@v3
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.7.7'
          channel: 'stable'
          cache: true
      
      # Set up environment
      - name: Set up environment
        run: .\scripts\setup.ps1

      # Navigate to repository root
      - run: cd ${{ github.workspace }}

      # Get dependencies for Flutter
      - name: Get dependencies
        run: flutter pub get

      # Run code generation
      - name: Run code generation
        run: flutter pub run build_runner build

      # Check for formatting in Flutter project
      - name: Format Flutter code
        run: dart format . --set-exit-if-changed -o none

      # Lint Flutter project
      - name: Lint Flutter code
        run: dart analyze
      
      - name: Test Flutter code
        run: flutter test .

      # Build Flutter project
      - name: Build Flutter project
        run: |
              if ($Env:RUNNER_OS -eq "Windows") {
                flutter build windows --verbose
              }
        shell: pwsh

      - name: Zip folder
        run: |
          cd ${{ github.workspace }}/build/windows/runner
          7z a -r -tzip Release.zip Release

      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: windows-artifact
          path: ${{ github.workspace }}/build/windows/runner/Release.zip
